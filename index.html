<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sumplete Játék</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
        }
        .grid {
            display: grid;
            margin: 20px auto;
            gap: 5px;
            width: calc(50vmin);
            height: calc(50vmin);
            grid-template-rows: repeat(var(--grid-size), 1fr);
            grid-template-columns: repeat(var(--grid-size), 1fr);
        }
        .cell {
            display: flex;
            justify-content: center;
            align-items: center;
            border: 1px solid #000;
            background-color: #fff;
            font-size: 18px;
            cursor: pointer;
            aspect-ratio: 1 / 1;
        }
        .cell.keep {
            background-color: #c6ffc6;
        }
        .cell.delete {
            background-color: #ffa6a6;
        }
        .cell.sum {
            background-color: #f0f0f0;
            font-weight: bold;
            cursor: default;
        }
        button, select {
            margin: 10px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }
    </style>
    <script>    
        let gridSize = 4; // Alapértelmezett méret
        let puzzleData = {};
        let timer, startTime, elapsedTime = 0;
        let gameStarted = false;

        // Időmérő
        function startTimer() {
            startTime = Date.now();
            timer = setInterval(() => {
                elapsedTime = Date.now() - startTime;
                document.getElementById("timer").textContent = formatTime(elapsedTime);
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timer);
        }

        function resetTimer() {
            clearInterval(timer);
            elapsedTime = 0;
            document.getElementById("timer").textContent = "00:00";
            gameStarted = false;
        }

        function formatTime(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes.toString().padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;
        }

        // Puzzle generálása
        function generatePuzzle(seed) {
            const randomNumbers = Array.from({ length: gridSize * gridSize }, (_, i) => (seed + i) % 9 + 1);

            const rowSums = [];
            const colSums = Array(gridSize).fill(0);

            for (let i = 0; i < gridSize; i++) {
                let rowSum = 0;
                for (let j = 0; j < gridSize; j++) {
                    const num = randomNumbers[i * gridSize + j];
                    rowSum += num;
                    colSums[j] += num;
                }
                rowSums.push(rowSum);
            }

            // Törlendő cellák kijelölése
            const cellsToRemove = Math.floor(gridSize * gridSize * 0.3);
            const indices = Array.from({ length: gridSize * gridSize }, (_, i) => i);
            for (let i = 0; i < cellsToRemove; i++) {
                const randomIndex = Math.floor(Math.random() * indices.length);
                const index = indices.splice(randomIndex, 1)[0];
                randomNumbers[index] = 0; // Nullázzuk a cellát
            }

            puzzleData = { numbers: randomNumbers, rowSums, colSums };
            renderGrid();
        }

        // Tábla kirajzolása
        function renderGrid() {
            const gridContainer = document.getElementById("grid");
            if (!gridContainer) {
                console.error("A 'grid' elem nem található!");
                return;
            }

            gridContainer.innerHTML = "";
            gridContainer.style.gridTemplateRows = `repeat(${gridSize + 1}, 1fr)`;
            gridContainer.style.gridTemplateColumns = `repeat(${gridSize + 1}, 1fr)`;

            for (let i = 0; i < gridSize + 1; i++) {
                for (let j = 0; j < gridSize + 1; j++) {
                    const cell = document.createElement("div");
                    cell.className = "cell";

                    if (i < gridSize && j === gridSize) {
                        cell.textContent = puzzleData.rowSums[i];
                        cell.classList.add("sum");
                    } else if (i === gridSize && j < gridSize) {
                        cell.textContent = puzzleData.colSums[j];
                        cell.classList.add("sum");
                    } else if (i < gridSize && j < gridSize) {
                        const num = puzzleData.numbers[i * gridSize + j];
                        cell.textContent = num > 0 ? num : "";
                        cell.addEventListener("click", () => toggleCellState(cell, i * gridSize + j));
                    }

                    gridContainer.appendChild(cell);
                }
            }
        }

        // Cellák állapotának váltása
        function toggleCellState(cell, index) {
            if (!gameStarted) {
                startTimer();
                gameStarted = true;
            }

            if (cell.classList.contains("delete")) {
                cell.classList.remove("delete");
                cell.classList.add("keep");
            } else if (cell.classList.contains("keep")) {
                cell.classList.remove("keep");
            } else {
                cell.classList.add("delete");
            }

            checkWinCondition();
        }

        // Győzelmi feltétel ellenőrzése
        function checkWinCondition() {
            const grid = document.getElementById("grid");
            const cells = Array.from(grid.children);
            let allCorrect = true;

            puzzleData.numbers.forEach((num, index) => {
                if (num === 0 && !cells[index].classList.contains("delete")) {
                    allCorrect = false;
                }
            });

            if (allCorrect) {
                stopTimer();
                alert(`Gratulálok! Az időd: ${formatTime(elapsedTime)}`);
            }
        }

        // Új játék indítása
        async function startGame() {
            resetTimer();
            const randomResponse = await fetch("random_szam.txt");
            const randomSeed = await randomResponse.text();
            const seed = parseInt(randomSeed.trim(), 10);
            generatePuzzle(seed);
        }

        // Új seed generálása
        async function generateNewSeed() {
            const newSeed = Math.floor(Math.random() * 1000000);
            await fetch("random_szam.txt", {
                method: "PUT",
                body: newSeed.toString(),
            });
            startGame();
        }

        // Méretváltoztatás kezelése
        function changeGridSize() {
            const selector = document.getElementById("size-selector");
            gridSize = parseInt(selector.value, 10);
            startGame();
        }

        // Oldal betöltésekor indítjuk az első játékot
        window.onload = startGame;
    </script>
</head>
<body>
    <h1>Sumplete Játék</h1>
    <h2>Idő: <span id="timer">00:00</span></h2>
    <div>
        <label for="size-selector">Pályaméret:</label>
        <select id="size-selector" onchange="changeGridSize()">
            <option value="3">3x3</option>
            <option value="4" selected>4x4</option>
            <option value="5">5x5</option>
            <option value="6">6x6</option>
            <option value="7">7x7</option>
            <option value="8">8x8</option>
        </select>
    </div>
    <button id="new-seed" onclick="generateNewSeed()">Új szám generálása</button>
    <div id="grid" class="grid"></div>
</body>
</html>

